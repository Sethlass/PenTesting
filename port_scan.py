# port_scan.py

import nmap

def advanced_port_scan(ip):
    """
    Perform an advanced port scan using Nmap with NSE scripts for vulnerabilities.

    Args:
        ip (str): The IP address to scan.

    Returns:
        dict: A dictionary containing open ports and detected vulnerabilities.
    """
    scanner = nmap.PortScanner()
    print(f"Scanning {ip} with NSE scripts for vulnerabilities...")

    # Use Nmap with specific vulnerability scripts for detected ports
    scanner.scan(ip, '135,139,445,902,912', arguments='--script=smb-vuln-*,vmware-version,vuln')

    results = {
        'open_ports': [],
        'vulnerabilities': []
    }

    if 'tcp' in scanner[ip]:
        for port in scanner[ip]['tcp']:
            if scanner[ip]['tcp'][port]['state'] == 'open':
                results['open_ports'].append(port)
                # Add detected vulnerabilities
                if 'script' in scanner[ip]['tcp'][port]:
                    for script, output in scanner[ip]['tcp'][port]['script'].items():
                        results['vulnerabilities'].append(f"{script}: {output}")

    return results
